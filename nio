# 1) Slice by raw column name
        df_seg = df_raw.filter(col("c0") == seg_code)
        if df_seg.rdd.isEmpty():
            print(f"No rows for {seg_key} ({seg_code}); skipping.")
            continue

        # 2) Enforce field count
        df_seg = apply_field_count(df_seg, field_count)

        # 3) Rename/pad to schema BEFORE any dedup/rollup (use schema names from here on)
        num_cols = len(df_seg.columns)
        df_seg = df_seg.select([
            col(f"c{i}").alias(schema_cols[i]) if i < num_cols else lit(None).alias(schema_cols[i])
            for i in range(len(schema_cols))
        ])

        # 4) Make sure all schema columns exist, then reorder to schema_cols
        for c in schema_cols:
            if c not in df_seg.columns:
                df_seg = df_seg.withColumn(c, lit(None))
        df_seg = df_seg.select(schema_cols)

        # 5) Dedup latest per key
        if dedup_keys:
            df_seg = dedup_latest(df_seg, dedup_keys, dedup_order)

        # 6) Roll up measures
        if rollup_keys and rollup_sums:
            df_seg = rollup(df_seg, rollup_keys, rollup_sums)

        # 7) Filter out RGN FILTERED OUT
        if "load_status" in df_seg.columns:
            df_seg = df_seg.filter((col("load_status").isNull()) | (col("load_status") != "RGN FILTERED OUT"))

        # 8) Add audit/meta columns
        load_uuid = str(uuid.uuid4())
        df_seg = (
            df_seg
            .withColumn("BATCH_ID", lit(load_uuid))
            .withColumn("CREATE_ID", lit("PYSPARK"))
            .withColumn("CREATE_DT", current_timestamp())
        )

        # 9) Final reorder to match table
        final_cols = schema_cols + ["BATCH_ID", "CREATE_ID", "CREATE_DT"]
        df_seg = df_seg.select([col(c) for c in final_cols])

        # 10) Write
        print(f"Write to Target DB Table: {target_table}")
        write_to_oracle(env, df_seg, target_table)
        tgt_count = get_table_count(spark, env, target_table, source_system)
        print(f"Target Count for {target_table}: {int(tgt_count)}")
